# KS-Sniff Local Rules
# Snort-compatible detection rules

# ============================================================
# Variables
# ============================================================
var HOME_NET [192.168.1.0/24,10.0.0.0/8]
var EXTERNAL_NET !$HOME_NET
var HTTP_PORTS [80,8080,8000:8100]
var HTTPS_PORTS [443,8443]
var SSH_PORTS 22
var DNS_PORTS 53

# ============================================================
# HTTP Detection Rules
# ============================================================

# HTTP GET requests
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"HTTP GET Request"; content:"GET"; sid:1000001; rev:1; priority:3;)

# HTTP POST requests
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"HTTP POST Request"; content:"POST"; sid:1000002; rev:1; priority:3;)

# Suspicious User-Agent strings
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"Suspicious User-Agent - wget"; content:"User-Agent|3A| wget"; sid:1000003; rev:1; priority:2;)

alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"Suspicious User-Agent - curl"; content:"User-Agent|3A| curl"; sid:1000004; rev:1; priority:2;)

# SQL Injection attempts
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"Possible SQL Injection - UNION SELECT"; content:"UNION"; content:"SELECT"; sid:1000005; rev:1; priority:1;)

alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"Possible SQL Injection - OR 1=1"; content:"OR"; content:"1=1"; sid:1000006; rev:1; priority:1;)

# XSS attempts
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"Possible XSS Attack - script tag"; content:"<script"; sid:1000007; rev:1; priority:1;)

# Directory traversal
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"Directory Traversal Attempt"; content:"../"; sid:1000008; rev:1; priority:1;)

# ============================================================
# HTTPS/TLS Detection Rules
# ============================================================

# TLS ClientHello
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTPS_PORTS (msg:"TLS ClientHello"; content:"|16 03|"; sid:1000100; rev:1; priority:3;)

# ============================================================
# SSH Detection Rules
# ============================================================

# SSH connection attempts
alert tcp $EXTERNAL_NET any -> $HOME_NET $SSH_PORTS (msg:"SSH Connection Attempt"; content:"SSH"; sid:1000200; rev:1; priority:3;)

# SSH brute force indicator
alert tcp $EXTERNAL_NET any -> $HOME_NET $SSH_PORTS (msg:"Possible SSH Brute Force"; content:"SSH"; sid:1000201; rev:1; priority:1;)

# ============================================================
# DNS Detection Rules
# ============================================================

# DNS queries
alert udp $EXTERNAL_NET any -> $HOME_NET $DNS_PORTS (msg:"DNS Query"; sid:1000300; rev:1; priority:3;)

# Suspicious DNS query
log udp any any -> any $DNS_PORTS (msg:"Unusually Long DNS Query"; sid:1000301; rev:1; priority:2;)

# ============================================================
# ICMP Detection Rules
# ============================================================

# ICMP Echo Request (ping)
alert icmp $EXTERNAL_NET any -> $HOME_NET any (msg:"ICMP Echo Request"; sid:1000400; rev:1; priority:3;)

# ICMP Echo Reply
alert icmp $HOME_NET any -> $EXTERNAL_NET any (msg:"ICMP Echo Reply"; sid:1000401; rev:1; priority:3;)

# ============================================================
# Port Scanning Detection
# ============================================================

# Potential TCP port scan
alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"Possible TCP Port Scan"; sid:1000500; rev:1; priority:2;)

# ============================================================
# Malware/C2 Detection
# ============================================================

# Generic HTTP C2 beacon
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible C2 Beacon"; sid:1000600; rev:1; priority:1;)

# Suspicious User-Agent patterns
alert tcp any any -> any any (msg:"Known Malware User-Agent"; content:"Mozilla/4.0 (compatible"; content:"MSIE 8.0"; sid:1000601; rev:1; priority:1;)

# ============================================================
# Suspicious Activity
# ============================================================

# Possible reverse shell
alert tcp any any -> any any (msg:"Possible Netcat Connection"; content:"/bin/sh"; sid:1000700; rev:1; priority:1;)

# Base64 encoded command execution
alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"Possible Base64 Encoded Command"; content:"base64"; sid:1000701; rev:1; priority:2;)

# ============================================================
# Examples of Different Rule Actions
# ============================================================

# Pass rule (allow specific traffic)
pass tcp $HOME_NET any -> $EXTERNAL_NET 443 (msg:"Allow HTTPS traffic"; sid:1000800; rev:1;)

# Log rule (log but don't alert)
log tcp any any -> any 8080 (msg:"Log traffic to port 8080"; sid:1000801; rev:1;)

# ============================================================
# Test Rules
# ============================================================

# Simple test rules for development
alert tcp any any -> any 80 (msg:"Test - HTTP port 80"; sid:1999997; rev:1;)
alert tcp any any -> any 443 (msg:"Test - HTTPS port 443"; sid:1999998; rev:1;)
alert tcp any any -> any any (msg:"Test - all TCP traffic"; sid:1999999; rev:1; priority:3;)
